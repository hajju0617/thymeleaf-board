<!-- layout.html을 상속 받도록 설정. -->
<html layout:decorate="~{layout}">
<!-- 부모 템플릿(layout.html)의 layout:fragment="content" 부분에 삽입되도록 설정. -->
<div layout:fragment="content" class="container my-3" style="max-width: 900px">
    <h4 class="my-3 border-bottom pb-2">비밀번호 변경</h4>
    <form th:action="@{/user/password/change}" th:object="${changePwDto}" method="post">
        <div th:replace="~{binding_result_errors :: bindingResultErrorsFragment}"></div>
        <div class="mb-4">
            <label for="currentPassword" class="form-label">현재 비밀번호</label>
            <input type="password" th:field="*{currentPassword}" class="form-control" placeholder="현재 비밀번호를 입력해 주세요." autofocus>
        </div>
        <div class="mb-4">
            <label for="newPassword" class="form-label">새 비밀번호</label>
            <input type="password" th:field="*{newPassword}" id="passwordInput" class="form-control" placeholder="영문 소문자, 숫자, 특수문자(!@#$%^&*)를 각각 최소 1개 이상 사용해서 8~20자리를 입력해 주세요.">
            <span id="password-msg"></span>
        </div>
        <div class="mb-4">
            <label for="confirmPassword" class="form-label">비밀번호 확인</label>
            <input type="password" th:field="*{confirmPassword}" id="passwordConfirmInput" class="form-control" placeholder="비밀번호를 다시 입력해 주세요.">
            <span id="passwordConfirm-msg"></span>
        </div>
        <button type="submit" class="btn btn-outline-primary w-100">변경하기</button>
    </form>
</div>
</html>

<script>
    const passwordRegexp = /^(?=.*[0-9])(?=.*[a-z])(?=.*[!@#$%^&*])\S{8,20}$/;
    const ALERT_COLORS = {
        SUCCESS: "blue",
        FAIL: "red"
    };

    function setMessage(id, msg, color) {
        const elementById = document.getElementById(id);
        elementById.textContent = msg;
        elementById.style.color = color;
    };

    // 비밀번호 유효성 검사.
    document.getElementById("passwordInput").addEventListener("input", e => {
        const valid = passwordRegexp.test(e.target.value);
        setMessage("password-msg",
            valid ? "올바른 비밀번호 형식이에요." : "비밀번호 형식이 올바르지 않아요. (소문자+숫자+특수문자 8~20자리)",
            valid ? ALERT_COLORS.SUCCESS : ALERT_COLORS.FAIL);

        // 비밀번호, 비밀번호 확인이 서로 일치했지만 추후 비밀번호만 변경시 비밀번호 확인 또한 변경된 값을 검증하기 위해서.
        document.getElementById("passwordConfirmInput").dispatchEvent(new Event("input"));
    });


    // 비밀번호 확인 검사.
    document.getElementById("passwordConfirmInput").addEventListener("input", e => {
        const password = document.getElementById("passwordInput").value;
        if (password.length === 0) {
            setMessage(passwordConfirmMsgId, "", "");
            return;
        }
        const passwordConfirm = e.target.value;
        let match = (password === passwordConfirm);
        setMessage("passwordConfirm-msg",
            match ? "비밀번호가 서로 일치해요" : "비밀번호가 서로 일치하지 않아요.",
            match ? ALERT_COLORS.SUCCESS : ALERT_COLORS.FAIL);
    });
</script>